<!DOCTYPE html>
<html>
<head>
    <title>Skribbl Clone - Live</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* --- MODERN GAME UI --- */
        body { 
            font-family: 'Open Sans', sans-serif; 
            background: #5D9CEC; /* Nice Blue Background */
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 20px; color: #333;
        }

        h1 { font-family: 'Fredoka One', cursive; color: white; text-shadow: 2px 2px 0px #333; font-size: 40px; margin-bottom: 10px; }

        /* LOGIN CARD */
        #loginScreen, #lobbyScreen { 
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 600px;
        }
        
        #lobbyScreen { display: none; max-width: 800px; }
        
        .lobby-section { 
            display: flex; gap: 20px; margin-top: 20px; 
        }
        
        .create-lobby, .join-lobby {
            flex: 1; padding: 20px; background: #f7f7f7; border-radius: 12px;
            text-align: left;
        }
        
        .lobby-section h3 { margin-top: 0; }
        
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            margin: 10px 0; padding: 8px;
        }
        
        .setting-row label { font-weight: 600; }
        
        .setting-row select, .setting-row input[type="number"] {
            width: 150px; padding: 6px; border-radius: 6px; border: 2px solid #ddd;
        }
        
        .lobby-list {
            max-height: 400px; overflow-y: auto; margin-top: 10px;
        }
        
        .lobby-item {
            background: white; padding: 15px; margin: 10px 0; border-radius: 8px;
            border: 2px solid #ddd; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .lobby-item:hover { border-color: #5D9CEC; transform: translateX(5px); }
        
        .lobby-info { text-align: left; }
        .lobby-info h4 { margin: 0 0 5px 0; }
        .lobby-info p { margin: 0; color: #666; font-size: 14px; }
        input { 
            width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; 
            border-radius: 8px; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #5D9CEC; }
        
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 5px; 
            transition: transform 0.1s; color: white;
        }
        button:active { transform: scale(0.95); }
        .btn-green { background: #48CFAD; box-shadow: 0 4px 0 #37BC9B; }
        .btn-blue { background: #4FC1E9; box-shadow: 0 4px 0 #3BAFDA; }
        .btn-yellow { background: #FFCE54; box-shadow: 0 4px 0 #F6BB42; color: #333; }

        /* GAME AREA */
        #gameArea { display: none; flex-direction: column; gap: 15px; width: 900px; }

        /* TOP BAR */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 10px 20px; border-radius: 12px; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .timer { font-family: 'Fredoka One', cursive; font-size: 32px; color: #ED5565; }
        .word-display { font-family: 'Fredoka One', cursive; font-size: 32px; letter-spacing: 8px; color: #333; }
        
        /* CANVAS & TOOLS */
        .main-container { display: flex; gap: 15px; }
        
        .canvas-wrapper { 
            position: relative; background: white; border-radius: 12px; 
            border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        .canvas-wrapper.drawer { border-color: #48CFAD; cursor: crosshair; }
        .canvas-wrapper.guesser { border-color: #ED5565; cursor: not-allowed; }

        #drawerOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(237, 85, 101, 0.1); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Fredoka One', cursive; font-size: 24px; color: #ED5565;
            pointer-events: none; z-index: 10;
        }

        .tools { 
            background: white; padding: 10px; border-radius: 12px; margin-top: 10px; 
            display: flex; gap: 10px; align-items: center; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .color-circle { 
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; 
            border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .color-circle:hover { transform: scale(1.1); }
        .color-circle.active { border-color: #333; }

        /* CHAT */
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 10px; }
        .chat-box { 
            height: 450px; background: white; border-radius: 12px; 
            padding: 10px; overflow-y: scroll; display: flex; flex-direction: column; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .message { margin-bottom: 6px; font-size: 14px; }
        .msg-system { color: #5D9CEC; font-weight: bold; font-style: italic; }
        .msg-correct { color: #48CFAD; font-weight: bold; background: #e6fffa; padding: 4px; border-radius: 4px; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>üé® Skribbl Clone</h1>

    <div id="loginScreen">
        <input type="text" id="username" placeholder="Choose a Nickname" value="Player1">
        <button class="btn-green" onclick="showLobbyScreen()">Play!</button>
        <div id="connStatus" style="margin-top:10px; font-size:12px; color:#aaa;">Connecting to server...</div>
    </div>

    <div id="lobbyScreen">
        <button onclick="backToLogin()" style="width: auto; padding: 8px 20px; margin-bottom: 15px;">‚Üê Back</button>
        
        <div class="lobby-section">
            <div class="create-lobby">
                <h3>Create Lobby</h3>
                
                <div class="setting-row">
                    <label>Language</label>
                    <select id="language">
                        <option>English (US)</option>
                        <option>Spanish</option>
                        <option>French</option>
                    </select>
                </div>
                
                <div class="setting-row">
                    <label>Scoring</label>
                    <select id="scoring">
                        <option>Chill</option>
                        <option>Normal</option>
                        <option>Competitive</option>
                    </select>
                </div>
                
                <div class="setting-row">
                    <label>Drawing Time</label>
                    <div>
                        <button onclick="adjustValue('drawTime', -10)">-</button>
                        <input type="number" id="drawTime" value="120" min="30" max="300" style="width: 60px; text-align: center;">
                        <button onclick="adjustValue('drawTime', 10)">+</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <label>Rounds</label>
                    <div>
                        <button onclick="adjustValue('rounds', -1)">-</button>
                        <input type="number" id="rounds" value="4" min="1" max="10" style="width: 60px; text-align: center;">
                        <button onclick="adjustValue('rounds', 1)">+</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <label>Maximum Players</label>
                    <div>
                        <button onclick="adjustValue('maxPlayers', -2)">-</button>
                        <input type="number" id="maxPlayers" value="24" min="2" max="50" style="width: 60px; text-align: center;">
                        <button onclick="adjustValue('maxPlayers', 2)">+</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <label>Players per IP Limit</label>
                    <div>
                        <button onclick="adjustValue('ipLimit', -1)">-</button>
                        <input type="number" id="ipLimit" value="2" min="1" max="10" style="width: 60px; text-align: center;">
                        <button onclick="adjustValue('ipLimit', 1)">+</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <label>Custom Words Per Turn</label>
                    <div>
                        <button onclick="adjustValue('customWords', -1)">-</button>
                        <input type="number" id="customWords" value="3" min="0" max="5" style="width: 60px; text-align: center;">
                        <button onclick="adjustValue('customWords', 1)">+</button>
                    </div>
                </div>
                
                <div class="setting-row" style="margin-top: 20px;">
                    <button class="btn-green" onclick="createRoomWithConfig(false)">Create Public Lobby</button>
                </div>
                <div class="setting-row">
                    <button class="btn-blue" onclick="createRoomWithConfig(true)">Create Private Lobby</button>
                </div>
            </div>
            
            <div class="join-lobby">
                <h3>Join Lobby</h3>
                
                <div style="margin-bottom: 15px;">
                    <input type="text" id="lobbyCode" placeholder="Enter Room Code" style="width: calc(100% - 24px); margin-bottom: 8px;">
                    <button class="btn-blue" onclick="joinLobbyByCode()" style="width: 100%;">Join Private Lobby</button>
                </div>
                
                <div style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0;">Public Lobbies</h4>
                    <button class="btn-blue" onclick="refreshLobbies()" style="width: 100%; margin-bottom: 10px;">üîÑ Refresh</button>
                    <div class="lobby-list" id="lobbyList">
                        <p style="color: #888; text-align: center; padding: 20px;">Loading lobbies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameArea">
        <div class="top-bar">
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <div class="timer" id="timerDisplay">60</div>
                <div style="font-size:12px; color:#888;" id="roundInfo">Round 1</div>
            </div>
            <div class="word-display" id="wordDisplay">WAITING...</div>
            <button id="startBtn" class="btn-yellow" style="width: auto; padding: 8px 20px;" onclick="startGame()">START GAME</button>
        </div>

        <div class="main-container">
            <div style="flex: 1;">
                <!-- Scoreboard -->
                <div id="scoreboard" style="background:white; padding:10px; border-radius:12px; margin-bottom:10px; box-shadow:0 4px 0 rgba(0,0,0,0.1);">
                    <div style="font-weight:bold; margin-bottom:5px; color:#333;">üèÜ Scoreboard</div>
                    <div id="scoreList" style="font-size:14px; color:#666;"></div>
                </div>

                <div class="canvas-wrapper" id="canvasContainer">
                    <canvas id="drawingCanvas" width="600" height="450"></canvas>
                    <div id="drawerOverlay">
                        <div>YOU ARE GUESSING</div>
                        <div style="font-size: 16px; color:#888; margin-top:5px">Look at the word hints above!</div>
                    </div>
                </div>

                <div class="tools" id="toolbar" style="display:none;">
                    <div class="color-circle" style="background:black" onclick="setColor('black')"></div>
                    <div class="color-circle" style="background:#ED5565" onclick="setColor('#ED5565')"></div> <div class="color-circle" style="background:#4FC1E9" onclick="setColor('#4FC1E9')"></div> <div class="color-circle" style="background:#48CFAD" onclick="setColor('#48CFAD')"></div> <div class="color-circle" style="background:#FFCE54" onclick="setColor('#FFCE54')"></div> <div style="flex:1"></div>
                    <button class="btn-red" style="width:auto; background:#ED5565; box-shadow:0 4px 0 #DA4453;" onclick="sendClear()">CLEAR</button>
                </div>
                
                <div id="roomInfo" style="margin-top:10px; color: white; font-weight: bold; text-align: center; opacity: 0.8;"></div>
            </div>

            <div class="sidebar">
                <div class="chat-box" id="chatBox"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chatInput" placeholder="Type your guess here..." style="margin:0;">
                    <button class="btn-blue" style="width:auto; margin:0;" onclick="sendChat()">SEND</button>
                </div>
            </div>
        </div>
    </div>

<script>
    var stompClient = null;
    var roomId = null;
    var username = null;
    var mySessionId = null;
    var amIDrawer = false;

    // Canvas Setup
    var canvas = document.getElementById('drawingCanvas');
    var ctx = canvas.getContext('2d');
    var isDrawing = false; var lastX=0; var lastY=0; var currentColor="black";

    // --- CONNECTION ---
    function connect(callback) {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; 

        stompClient.connect({}, function (frame) {
            document.getElementById("connStatus").innerText = "Connected!";
            document.getElementById("connStatus").style.color = "#48CFAD";
            
            // LOGIC FIX: Extract ID correctly
            var url = stompClient.ws._transport.url; 
            var parts = url.split("/");
            mySessionId = parts[parts.length - 2];
            console.log("My ID:", mySessionId);
            
            if(callback) callback();
        }, function(err) { alert("Connection Failed. Is backend running?"); });
    }

    // --- LOBBY FUNCTIONS ---
    function showLobbyScreen() {
        username = document.getElementById("username").value.trim();
        if (!username) {
            alert("Please enter a nickname!");
            return;
        }
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("lobbyScreen").style.display = "block";
        connect(function() {
            refreshLobbies();
        });
    }
    
    function backToLogin() {
        document.getElementById("lobbyScreen").style.display = "none";
        document.getElementById("loginScreen").style.display = "block";
        if (stompClient) stompClient.disconnect();
    }
    
    function adjustValue(id, delta) {
        var input = document.getElementById(id);
        var newValue = parseInt(input.value) + delta;
        var min = parseInt(input.min);
        var max = parseInt(input.max);
        if (newValue >= min && newValue <= max) {
            input.value = newValue;
        }
    }
    
    function createRoomWithConfig(isPrivate) {
        var config = {
            language: document.getElementById("language").value,
            scoringMode: document.getElementById("scoring").value,
            drawingTime: parseInt(document.getElementById("drawTime").value),
            rounds: parseInt(document.getElementById("rounds").value),
            maxPlayers: parseInt(document.getElementById("maxPlayers").value),
            playersPerIpLimit: parseInt(document.getElementById("ipLimit").value),
            customWordsPerTurn: parseInt(document.getElementById("customWords").value),
            customWords: [],
            isPrivate: isPrivate,
            lobbyName: username + "'s Game"
        };
        
        var roomCode = Math.floor(100000 + Math.random() * 900000).toString();
        roomId = roomCode;
        
        // Subscribe to room and then join via WebSocket
        stompClient.subscribe('/topic/room/' + roomId + '/draw', function(m){ handleDraw(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/chat', function(m){ handleChat(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/state', function(m){ handleState(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/time', function(m){ document.getElementById("timerDisplay").innerText = m.body; });
        stompClient.subscribe('/user/queue/draw', function(m){ handleDraw(JSON.parse(m.body)); });
        
        // Send join message with config embedded
        stompClient.send("/app/join", {}, JSON.stringify({
            'username': username, 
            'roomId': roomId, 
            'action': 'create',
            'config': config
        }));
        
        document.getElementById("lobbyScreen").style.display = "none";
        document.getElementById("gameArea").style.display = "flex";
        document.getElementById("roomInfo").innerText = "ROOM CODE: " + roomId;
    }
    
    function refreshLobbies() {
        fetch('/api/lobby/list')
            .then(res => res.json())
            .then(lobbies => {
                var listDiv = document.getElementById("lobbyList");
                if (lobbies.length === 0) {
                    listDiv.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No public lobbies available</p>';
                } else {
                    listDiv.innerHTML = lobbies.map(lobby => `
                        <div class="lobby-item" onclick="joinLobby('${lobby.roomId}')">
                            <div class="lobby-info">
                                <h4>${lobby.lobbyName || 'Game Room'}</h4>
                                <p>${lobby.players.length}/${lobby.maxPlayers} players ‚Ä¢ ${lobby.drawingTime}s ‚Ä¢ ${lobby.maxRounds} rounds</p>
                            </div>
                            <button class="btn-blue" style="width: auto; padding: 8px 16px;">Join ‚Üí</button>
                        </div>
                    `).join('');
                }
            })
            .catch(err => {
                console.error("Failed to load lobbies:", err);
                document.getElementById("lobbyList").innerHTML = '<p style="color: #ED5565; text-align: center; padding: 20px;">Failed to load lobbies</p>';
            });
    }
    
    function joinLobbyByCode() {
        var code = document.getElementById("lobbyCode").value.trim();
        if (!code) {
            alert("Please enter a room code!");
            return;
        }
        joinLobby(code);
    }
    
    function joinLobby(code) {
        roomId = code;
        
        stompClient.subscribe('/topic/room/' + roomId + '/draw', function(m){ handleDraw(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/chat', function(m){ handleChat(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/state', function(m){ handleState(JSON.parse(m.body)); });
        stompClient.subscribe('/topic/room/' + roomId + '/time', function(m){ document.getElementById("timerDisplay").innerText = m.body; });
        stompClient.subscribe('/user/queue/draw', function(m){ handleDraw(JSON.parse(m.body)); });
        
        stompClient.send("/app/join", {}, JSON.stringify({'username': username, 'roomId': roomId, 'action': 'join'}));
        
        document.getElementById("lobbyScreen").style.display = "none";
        document.getElementById("gameArea").style.display = "flex";
        document.getElementById("roomInfo").innerText = "ROOM CODE: " + roomId;
    }
    
    function createRoom() {
        startConnection('create', Math.floor(100000 + Math.random() * 900000).toString());
    }
    function joinRoom() {
        var code = document.getElementById("joinCode").value;
        if(!code) return alert("Enter a room code");
        startConnection('join', code);
    }

    function startConnection(action, code) {
        username = document.getElementById("username").value;
        roomId = code;
        connect(function() {
            // Subscribe to everything
            stompClient.subscribe('/topic/room/' + roomId + '/draw', function(m){ handleDraw(JSON.parse(m.body)); });
            stompClient.subscribe('/topic/room/' + roomId + '/chat', function(m){ handleChat(JSON.parse(m.body)); });
            stompClient.subscribe('/topic/room/' + roomId + '/state', function(m){ handleState(JSON.parse(m.body)); });
            stompClient.subscribe('/topic/room/' + roomId + '/time', function(m){ document.getElementById("timerDisplay").innerText = m.body; });
            stompClient.subscribe('/user/queue/draw', function(m){ handleDraw(JSON.parse(m.body)); });

            stompClient.send("/app/join", {}, JSON.stringify({'username': username, 'roomId': roomId, 'action': action}));

            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("gameArea").style.display = "flex";
            document.getElementById("roomInfo").innerText = "ROOM CODE: " + roomId;
        });
    }

    function startGame() {
        stompClient.send("/app/start/" + roomId, {}, {});
        document.getElementById("startBtn").style.display = "none";
    }

    // --- GAME STATE LOGIC (FULLY FIXED) ---
    function handleState(room) {
        console.log("üîÑ State Update Received:", room);
        
        // Update scoreboard
        updateScoreboard(room.players || []);
        
        // Update round info
        var totalTurns = room.maxRounds * (room.players ? room.players.length : 1);
        var currentTurn = (room.currentRound - 1) * (room.players ? room.players.length : 1) + (room.drawerIndex >= 0 ? room.drawerIndex : 0) + 1;
        document.getElementById("roundInfo").innerText = "Turn " + currentTurn + "/" + totalTurns + " | Round " + room.currentRound + "/" + room.maxRounds;
        
        // Check if game is running - handle both property names
        var running = room.isGameRunning || room.gameRunning || false;
        
        // If game not running and no drawer, just return
        if(!running && !room.currentDrawerSessionId) {
            console.log("‚è∏Ô∏è Game not started yet");
            return;
        }

        // Determine if I'm the drawer
        amIDrawer = (mySessionId === room.currentDrawerSessionId);
        console.log("üë§ Am I Drawer?", amIDrawer, "| My ID:", mySessionId, "| Drawer ID:", room.currentDrawerSessionId);
        
        var canvasDiv = document.getElementById("canvasContainer");
        var toolbar = document.getElementById("toolbar");
        var overlay = document.getElementById("drawerOverlay");
        var wordDiv = document.getElementById("wordDisplay");

        var chatInput = document.getElementById("chatInput");
        
        if (amIDrawer) {
            // ===== DRAWER MODE =====
            canvasDiv.className = "canvas-wrapper drawer";
            toolbar.style.display = "flex";
            overlay.style.display = "none";
            
            // Disable chat for drawer (they already know the word!)
            chatInput.disabled = true;
            chatInput.placeholder = "You are drawing! Others will guess...";
            chatInput.style.backgroundColor = "#f0f0f0";
            
            // Show REAL WORD
            var word = room.currentWord || "LOADING...";
            wordDiv.innerText = word.toUpperCase();
            wordDiv.style.letterSpacing = "8px";
            console.log("‚úèÔ∏è DRAWER MODE - Word:", word);
        } else {
            // ===== GUESSER MODE =====
            canvasDiv.className = "canvas-wrapper guesser";
            toolbar.style.display = "none";
            overlay.style.display = "none"; // REMOVE OVERLAY - let them see the drawing!
            
            // Enable chat for guessers
            chatInput.disabled = false;
            chatInput.placeholder = "Type your guess here...";
            chatInput.style.backgroundColor = "white";
            
            // Show HINT WORD - this comes from backend with revealed letters
            var hint = room.hintWord || "_ _ _ _ _";
            wordDiv.innerText = hint.toUpperCase();
            wordDiv.style.letterSpacing = "4px"; // Smaller spacing for hints
            console.log("üëÄ GUESSER MODE - Hint:", hint);
        }
    }
    
    function updateScoreboard(players) {
        var scoreList = document.getElementById("scoreList");
        if (!players || players.length === 0) {
            scoreList.innerHTML = "Waiting for players...";
            return;
        }
        
        // Sort by score descending
        players.sort((a, b) => b.score - a.score);
        
        var html = "";
        players.forEach((player, index) => {
            var medal = index === 0 ? "ü•á" : (index === 1 ? "ü•à" : (index === 2 ? "ü•â" : ""));
            var isMe = player.sessionId === mySessionId;
            var style = isMe ? "font-weight:bold; background:#e6f7ff; padding:2px 5px; border-radius:4px;" : "";
            html += "<div style='" + style + "'>" + medal + " " + player.username + ": " + player.score + " pts</div>";
        });
        
        scoreList.innerHTML = html;
    }

    // --- DRAWING ---
    canvas.addEventListener('mousedown', function(e) { if(amIDrawer){ isDrawing=true; lastX=e.offsetX; lastY=e.offsetY; }});
    canvas.addEventListener('mousemove', function(e) {
        if(!isDrawing || !amIDrawer) return;
        var cx=e.offsetX; var cy=e.offsetY;
        draw(lastX, lastY, cx, cy, currentColor);
        stompClient.send("/app/draw/"+roomId, {}, JSON.stringify({'type':'DRAW','prevX':lastX,'prevY':lastY,'currX':cx,'currY':cy,'color':currentColor,'lineWidth':5}));
        lastX=cx; lastY=cy;
    });
    canvas.addEventListener('mouseup', function(){ isDrawing=false; });

    function handleDraw(data) {
        if(data.type==="CLEAR") ctx.clearRect(0,0,canvas.width,canvas.height);
        else draw(data.prevX, data.prevY, data.currX, data.currY, data.color);
    }
    function draw(x1,y1,x2,y2,c) {
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.strokeStyle=c; ctx.lineWidth=5; ctx.lineCap="round"; ctx.stroke();
    }
    function setColor(c){ currentColor=c; }
    function sendClear(){ if(amIDrawer) stompClient.send("/app/draw/"+roomId, {}, JSON.stringify({'type':'CLEAR'})); }

    // --- CHAT ---
    function sendChat(){ 
        var input = document.getElementById("chatInput");
        var val = input.value;
        if(val) stompClient.send("/app/chat/"+roomId, {}, JSON.stringify({'sender':username,'content':val,'type':'CHAT'}));
        input.value="";
    }
    // Allow Enter key to send
    document.getElementById("chatInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") sendChat();
    });

    function handleChat(data) {
        var box = document.getElementById("chatBox");
        var div = document.createElement("div");
        div.className = "message";
        
        if(data.type==="GUESS_CORRECT") { 
            div.className += " msg-correct"; 
            div.innerText = "üéâ " + data.content; 
        }
        else if(data.type==="JOIN" || data.type==="SYSTEM") { 
            div.className += " msg-system"; 
            div.innerText = data.content; 
        }
        else { 
            div.innerHTML = "<b>" + data.sender + ":</b> " + data.content; 
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>